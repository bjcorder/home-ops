- hosts: "loadbalancers"
  become: yes
  gather_facts: true
  tasks:

  - name: Install HAproxy and keepalived
    ansible.builtin.apt:
      pkg:
      - haproxy
      - keepalived
      update_cache: yes
      
  - name: Copy HAproxy config to service location
    ansible.builtin.copy:
      src: "../../../configs/{{ inventory_hostname }}/haproxy.cfg"
      dest: /etc/haproxy/haproxy.cfg
      validate: sudo haproxy -f %s -c
  
  - name: Add LF to end of HAproxy config file
    ansible.builtin.command: echo "" >> /etc/haproxy/haproxy.cfg

  - name: Copy keepalived config to service location
    ansible.builtin.copy:
      src: "../../../configs/{{ inventory_hostname }}/haproxy.cfg"
      dest: /etc/keepalived/keepalived.conf
      validate: sudo keepalived -t %s

  - name: Restart service haproxy
    ansible.builtin.service:
      name: haproxy
      state: restarted

  - name: Restart service keepalived
    ansible.builtin.service:
      name: keepalived
      state: restarted